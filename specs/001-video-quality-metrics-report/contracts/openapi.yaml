openapi: 3.0.3
info:
  title: VQMR API
  description: |
    视频质量指标报告系统（Video Quality Metrics Report）API

    ## 功能概述
    - 提交视频编码任务（ABR/CRF 码控）
    - 计算质量指标（PSNR/VMAF/SSIM）
    - 生成可视化报告
    - 导出 JSON/CSV 数据

    ## 技术栈
    - FastAPI + Uvicorn
    - Jinja2 模板引擎
    - FFmpeg 视频处理
    - Chart.js 可视化
  version: 0.1.0
  contact:
    name: VQMR 项目
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: 开发服务器
  - url: http://{server_ip}:{port}
    description: 生产服务器
    variables:
      server_ip:
        default: "192.168.1.100"
      port:
        default: "8080"

tags:
  - name: 页面
    description: HTML 页面端点
  - name: 任务
    description: 编码任务管理
  - name: 数据
    description: 指标数据导出
  - name: 系统
    description: 系统健康检查

paths:
  /:
    get:
      summary: 上传页面
      description: 返回任务提交表单（单/双文件模式）
      operationId: upload_page
      tags:
        - 页面
      responses:
        '200':
          description: 成功返回上传页面
          content:
            text/html:
              schema:
                type: string

  /jobs:
    post:
      summary: 创建编码任务
      description: 提交编码任务，验证输入后加入队列
      operationId: create_job
      tags:
        - 任务
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/CreateJobRequest'
      responses:
        '303':
          description: 任务创建成功，重定向到任务详情页
          headers:
            Location:
              description: 任务详情页 URL
              schema:
                type: string
                example: /jobs/abc123def456
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateJobResponse'
        '422':
          description: 验证失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '413':
          description: 文件过大
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /jobs/{job_id}:
    get:
      summary: 任务详情/报告页
      description: 返回任务状态和可视化报告（HTML）
      operationId: job_report
      tags:
        - 页面
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: 成功返回报告页
          content:
            text/html:
              schema:
                type: string
        '404':
          description: 任务 ID 不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /jobs/{job_id}/status:
    get:
      summary: 任务状态
      description: 返回任务当前状态和进度（JSON）
      operationId: job_status
      tags:
        - 任务
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: 成功返回状态
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobStatus'
        '404':
          description: 任务 ID 不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /jobs/{job_id}/psnr.json:
    get:
      summary: 质量指标（JSON）
      description: 返回完整质量指标数据（程序化访问）
      operationId: psnr_json
      tags:
        - 数据
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: 成功返回指标数据
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '404':
          description: 任务 ID 不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: 任务未完成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /jobs/{job_id}/psnr.csv:
    get:
      summary: 质量指标（CSV）
      description: 导出逐帧质量指标为 CSV 格式
      operationId: psnr_csv
      tags:
        - 数据
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: 成功返回 CSV
          headers:
            Content-Disposition:
              description: 下载文件名
              schema:
                type: string
                example: attachment; filename="abc123def456_metrics.csv"
          content:
            text/csv:
              schema:
                type: string
        '404':
          description: 任务 ID 不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: 任务未完成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /health:
    get:
      summary: 健康检查
      description: 返回服务健康状态
      operationId: health_check
      tags:
        - 系统
      responses:
        '200':
          description: 服务健康
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheck'
        '503':
          description: 服务不可用
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  parameters:
    JobId:
      name: job_id
      in: path
      required: true
      description: 任务唯一标识符（nanoid, 12 字符）
      schema:
        type: string
        pattern: '^[a-zA-Z0-9]{12}$'
        example: abc123def456

  schemas:
    CreateJobRequest:
      type: object
      required:
        - encoder_path
        - video_file
        - rate_control
        - rate_values
      properties:
        encoder_path:
          type: string
          description: 编码器可执行文件的绝对路径
          example: /usr/bin/x264
        video_file:
          type: string
          format: binary
          description: 上传的视频文件
        rate_control:
          type: string
          enum: [abr, crf]
          description: 码控模式（ABR 或 CRF）
        rate_values:
          type: string
          description: 码控参数值（逗号分隔，1-10 个值）
          example: "500,1000,2000"
        video_format:
          type: string
          enum: [container, raw_yuv]
          default: container
          description: 视频格式类型
        yuv_resolution:
          type: string
          pattern: '^\d+x\d+$'
          description: YUV 分辨率（仅 raw_yuv 格式需要）
          example: "1920x1080"
        yuv_pixel_format:
          type: string
          enum: [yuv420p, yuv422p, yuv444p]
          description: YUV 像素格式（仅 raw_yuv 格式需要）
        yuv_frame_rate:
          type: number
          format: float
          minimum: 1
          maximum: 240
          description: YUV 帧率（仅 raw_yuv 格式需要）
          example: 30.0

    CreateJobResponse:
      type: object
      properties:
        job_id:
          type: string
          example: abc123def456
        status:
          type: string
          enum: [queued]
          example: queued
        created_at:
          type: string
          format: date-time
          example: "2025-10-25T10:30:00Z"
        message:
          type: string
          example: "任务已创建，正在处理中"

    JobStatus:
      type: object
      properties:
        job_id:
          type: string
          example: abc123def456
        status:
          type: string
          enum: [queued, processing, completed, failed, cancelled]
        progress:
          $ref: '#/components/schemas/TaskProgress'
        error:
          type: string
          nullable: true
          example: null
        updated_at:
          type: string
          format: date-time
          example: "2025-10-25T10:35:00Z"

    TaskProgress:
      type: object
      properties:
        current_rate_param:
          type: number
          nullable: true
          example: 1000
        completed_params:
          type: array
          items:
            type: number
          example: [500]
        total_tasks:
          type: integer
          example: 3
        completed_tasks:
          type: integer
          example: 1
        progress_percent:
          type: number
          format: float
          example: 33.33

    Report:
      type: object
      properties:
        job_id:
          type: string
          example: abc123def456
        video_metadata:
          $ref: '#/components/schemas/VideoMetadata'
        results:
          type: array
          items:
            $ref: '#/components/schemas/EncodingResult'
        created_at:
          type: string
          format: date-time
          example: "2025-10-25T10:45:00Z"

    VideoMetadata:
      type: object
      properties:
        resolution:
          type: string
          example: "1920x1080"
        frame_rate:
          type: number
          format: float
          example: 30.0
        codec:
          type: string
          example: "h264"
        duration:
          type: number
          format: float
          example: 10.5

    EncodingResult:
      type: object
      properties:
        rate_control_param:
          type: number
          example: 1000
        quality_metrics:
          $ref: '#/components/schemas/QualityMetrics'
        performance_metrics:
          $ref: '#/components/schemas/PerformanceMetrics'

    QualityMetrics:
      type: object
      properties:
        psnr_y:
          type: number
          format: float
          example: 42.35
        psnr_u:
          type: number
          format: float
          example: 45.12
        psnr_v:
          type: number
          format: float
          example: 44.87
        psnr_avg:
          type: number
          format: float
          example: 44.11
        vmaf:
          type: number
          format: float
          minimum: 0
          maximum: 100
          example: 85.67
        ssim:
          type: number
          format: float
          minimum: 0
          maximum: 1
          example: 0.9823
        actual_bitrate:
          type: integer
          example: 1987
        frames:
          type: array
          items:
            $ref: '#/components/schemas/FrameMetrics'

    FrameMetrics:
      type: object
      properties:
        frame_number:
          type: integer
          minimum: 1
          example: 1
        psnr_y:
          type: number
          format: float
          example: 43.2
        vmaf:
          type: number
          format: float
          example: 86.5
        ssim:
          type: number
          format: float
          example: 0.984

    PerformanceMetrics:
      type: object
      properties:
        encoding_time:
          type: number
          format: float
          example: 12.5
        encoding_speed:
          type: number
          format: float
          example: 25.2
        cpu_utilization:
          type: number
          format: float
          minimum: 0
          maximum: 100
          example: 85.3
        frame_latency:
          $ref: '#/components/schemas/FrameLatencyStats'

    FrameLatencyStats:
      type: object
      properties:
        avg_ms:
          type: number
          format: float
          example: 40.5
        min_ms:
          type: number
          format: float
          example: 25.3
        max_ms:
          type: number
          format: float
          example: 75.8

    HealthCheck:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          example: healthy
        version:
          type: string
          example: "0.1.0"
        uptime_seconds:
          type: number
          format: float
          example: 3600.5
        checks:
          type: object
          properties:
            ffmpeg:
              type: string
              enum: [available, missing]
              example: available
            vmaf_model:
              type: string
              enum: [available, missing]
              example: available
            disk_space_gb:
              type: number
              format: float
              example: 150.3

    ValidationError:
      type: object
      properties:
        detail:
          type: array
          items:
            type: object
            properties:
              loc:
                type: array
                items:
                  type: string
                example: ["body", "encoder_path"]
              msg:
                type: string
                example: "编码器文件不存在: /usr/bin/x264"
              type:
                type: string
                example: "value_error"

    Error:
      type: object
      properties:
        detail:
          type: string
          example: "任务 ID 不存在: abc123def456"
