{% extends "base.html" %}

{% block title %}模板管理 - VMA{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">模板管理</h1>
      <p class="text-sm text-gray-600">支持对比模板与 Metrics 分析模板</p>
    </div>
    <a href="/templates/new" class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700">新建模板</a>
  </div>

  <div id="loading" class="rounded-lg border border-blue-100 bg-blue-50 px-4 py-3 text-sm text-blue-700 hidden">正在加载模板...</div>
  <div id="emptyState" class="hidden rounded-lg border border-dashed border-gray-300 bg-gray-50 p-6 text-center text-gray-600">
    暂无模板，请创建一个新模板。
  </div>

  <div class="flex items-center gap-3">
    <label class="text-sm text-gray-700">类型筛选：</label>
    <select id="typeFilter" class="border rounded px-3 py-2 text-sm">
      <option value="all">全部</option>
      <option value="comparison">Metrics 对比模板</option>
      <option value="metrics_analysis">Metrics 分析模板</option>
    </select>
  </div>

  <div id="templatesGrid" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let templates = [];

async function loadTemplates() {
  document.getElementById('loading').classList.remove('hidden');
  document.getElementById('emptyState').classList.add('hidden');
  document.getElementById('templatesGrid').classList.add('hidden');
  try {
    const [compRes, metricsRes] = await Promise.all([
      fetch('/api/templates'),
      fetch('/api/metrics-analysis/templates')
    ]);
    if (!compRes.ok) throw new Error('加载对比模板失败');
    if (!metricsRes.ok) throw new Error('加载 Metrics 模板失败');
    const comp = await compRes.json();
    const metrics = await metricsRes.json();
    const normalizedMetrics = metrics.map(m => ({
      template_id: m.template_id,
      name: m.name,
      description: m.description,
      created_at: m.created_at,
      template_type: m.template_type,
      baseline_source_dir: m.source_dir,
      baseline_bitstream_dir: m.bitstream_dir,
      test_source_dir: null,
      test_bitstream_dir: null,
      baseline_computed: false,
    }));
    templates = [...comp, ...normalizedMetrics];
    document.getElementById('loading').classList.add('hidden');
    if (!templates.length) {
      document.getElementById('emptyState').classList.remove('hidden');
      return;
    }
    renderTemplates();
  } catch (err) {
    document.getElementById('loading').classList.add('hidden');
    showToast(err.message || '加载模板失败', 'error');
  }
}

function renderTemplates() {
  const grid = document.getElementById('templatesGrid');
  grid.innerHTML = '';
  grid.classList.remove('hidden');
  const filter = document.getElementById('typeFilter').value;
  const filtered = templates.filter(t => filter === 'all' || t.template_type === filter);
  filtered.forEach(tpl => {
    const card = document.createElement('div');
    card.className = 'rounded-lg border border-gray-200 bg-white p-4 shadow-sm flex flex-col gap-2';
    const typeLabel = tpl.template_type === 'metrics_analysis' ? '<span class="ml-2 px-2 py-1 rounded text-xs font-medium bg-indigo-100 text-indigo-700">Metrics</span>' : '<span class="ml-2 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">对比</span>';
    const expBlock = tpl.template_type === 'metrics_analysis' ? '' : `
      <div class="text-xs text-gray-600 bg-gray-50 rounded p-2">
        <div class="font-semibold text-gray-700">Test</div>
        <div>源目录：${escapeHtml(tpl.test_source_dir || '')}</div>
        <div>码流目录：${escapeHtml(tpl.test_bitstream_dir || '')}</div>
      </div>`;
    const statusHtml = tpl.template_type === 'metrics_analysis'
      ? '<span class="px-2 py-1 rounded text-xs font-medium text-gray-700 border border-gray-200">单侧模板</span>'
      : (tpl.baseline_computed
          ? '<span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800 border border-green-200">Baseline 已计算</span>'
          : '<span class="text-xs font-medium text-gray-500">Baseline 未计算</span>');
    card.innerHTML = `
      <div class="flex items-center justify-between">
        <div>
          <div class="text-lg font-semibold text-gray-900">${escapeHtml(tpl.name || tpl.template_id)} ${typeLabel}</div>
          <div class="text-xs text-gray-500">ID: ${tpl.template_id}</div>
        </div>
        ${statusHtml}
      </div>
      <div class="text-sm text-gray-700">${escapeHtml(tpl.description || '无描述')}</div>
      <div class="text-xs text-gray-600 bg-gray-50 rounded p-2">
        <div class="font-semibold text-gray-700">${tpl.template_type === 'metrics_analysis' ? '编码配置' : 'Baseline'}</div>
        <div>源目录：${escapeHtml(tpl.baseline_source_dir || '')}</div>
        <div>码流目录：${escapeHtml(tpl.baseline_bitstream_dir || '')}</div>
      </div>
      ${expBlock}
      <div class="flex items-center justify-between text-xs text-gray-500">
        <span>创建时间：${tpl.created_at ? tpl.created_at.replace('T',' ').split('.')[0] : ''}</span>
        <div class="space-x-2">
          <a href="/templates/${tpl.template_id}" class="inline-flex items-center px-3 py-1 rounded border border-gray-300 text-sm text-gray-700 hover:bg-gray-100">查看</a>
          <a href="/templates/${tpl.template_id}/edit${tpl.template_type === 'metrics_analysis' ? '?type=metrics' : ''}" class="inline-flex items-center px-3 py-1 rounded border border-blue-500 text-sm text-blue-600 hover:bg-blue-50">编辑</a>
          <button data-id="${tpl.template_id}" data-type="${tpl.template_type}" class="inline-flex items-center px-3 py-1 rounded border border-red-400 text-sm text-red-600 hover:bg-red-50 delete-btn">删除</button>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
  bindDelete();
}

function bindDelete() {
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = e.target.dataset.id;
      const t = e.target.dataset.type;
      showDeleteConfirm(e, {
        title: '确认删除该模板？',
        message: '此操作无法撤销。',
        onConfirm: () => deleteTemplate(id, t)
      });
    });
  });
}

async function deleteTemplate(id, t) {
  try {
    const url = t === 'metrics_analysis' ? `/api/metrics-analysis/templates/${id}` : `/api/templates/${id}`;
    const res = await fetch(url, { method: 'DELETE' });
    if (!res.ok) throw new Error('删除失败');
    showToast('删除成功', 'success');
    loadTemplates();
  } catch (err) {
    showToast(err.message || '删除失败', 'error');
  }
}

const typeFilter = document.getElementById('typeFilter');
typeFilter.addEventListener('change', renderTemplates);
const params = new URLSearchParams(window.location.search);
const initType = params.get('type') === 'metrics' ? 'metrics_analysis' : 'all';
typeFilter.value = initType;

loadTemplates();
</script>
{% endblock %}
