{% extends "base.html" %}

{% block title %}码流分析 - VQMR{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-start justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">码流分析</h1>
            <p class="mt-1 text-sm text-gray-600">
                载入参考视频 Reference 和一个或多个编码后视频 Distorted，后台计算 PSNR / SSIM / VMAF / VMAF-NEG / Bitrate，并生成分析报告。
            </p>
            <p class="mt-1 text-xs text-gray-500">
                说明：所有打分输入统一转换为 yuv420p；若分辨率不一致会先将 Distorted 对齐到 Reference；若帧数/时长不一致任务会进行截断。
            </p>
        </div>
        <a href="/" class="text-blue-600 hover:text-blue-800 text-sm font-medium">← 返回首页</a>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6">
        <form id="bitstreamForm" class="space-y-6" enctype="multipart/form-data">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Reference -->
                <div class="space-y-3">
                    <h2 class="text-sm font-semibold text-gray-900">参考视频 Reference</h2>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">视频路径</label>
                        <div class="relative">
                            <input id="refPath" name="reference_path" type="text"
                                   placeholder="/path/to/ref.mp4 or /path/to/ref.yuv"
                                   class="w-full pr-24 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            <label class="absolute inset-y-0 right-1 my-1 px-3 flex items-center text-sm font-semibold text-blue-700 bg-blue-50 rounded-md border border-blue-200 cursor-pointer hover:bg-blue-100">
                                选择
                                <input id="refInput" name="reference_file" type="file" class="hidden" />
                            </label>
                        </div>
                        <div class="text-left text-xs text-gray-500 mt-1"> 或</div>
                        <div id="refDrop" class="mt-2 border-2 border-dashed border-gray-300 rounded-lg p-3 text-sm text-gray-600 bg-gray-50 hover:border-blue-400 hover:bg-blue-50 transition-colors">
                            将文件拖拽到此处上传
                        </div>
                        <div id="refFileName" class="text-xs text-gray-600"></div>
                    </div>
                </div>

                <!-- Encoded -->
                <div class="space-y-3">
                    <h2 class="text-sm font-semibold text-gray-900">失真视频 Distorted</h2>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">文件路径（多个文件换行分隔）</label>
                        <div class="relative">
                            <textarea id="encPaths" name="encoded_paths" rows="4"
                                      placeholder="/path/to/encoded_a.mp4&#10;/path/to/encoded_b.h265"
                                      class="w-full pr-24 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            <label class="absolute top-2 right-1 px-3 py-1.5 text-sm font-semibold text-blue-700 bg-blue-50 rounded-md border border-blue-200 cursor-pointer hover:bg-blue-100">
                                选择
                                <input id="encInput" name="encoded_files" type="file" multiple class="hidden" />
                            </label>
                        </div>
                        <div class="text-left text-xs text-gray-500 mt-1"> 或</div>
                        <div id="encDrop" class="mt-2 border-2 border-dashed border-gray-300 rounded-lg p-3 text-sm text-gray-600 bg-gray-50 hover:border-blue-400 hover:bg-blue-50 transition-colors">
                            将一个或多个文件拖拽到此处上传
                        </div>
                        <div id="encFileName" class="text-xs text-gray-600"></div>
                    </div>
                </div>
            </div>

            <!-- Rawvideo params (Ref 为 yuv 时显示) -->
            <div id="rawParams" class="border-t border-gray-200 pt-6 hidden">
                <h2 class="text-sm font-semibold text-gray-900">参考视频为 YUV 时必填</h2>
                <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Width</label>
                        <input name="width" type="number" min="1"
                               placeholder="例如 1920"
                               class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Height</label>
                        <input name="height" type="number" min="1"
                               placeholder="例如 1080"
                               class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">FPS</label>
                        <input name="fps" type="number" min="0.1" step="0.001"
                               placeholder="例如 30"
                               class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                </div>
                <p class="mt-2 text-xs text-gray-500">默认像素格式为 yuv420p。</p>
            </div>

            <div class="flex items-center justify-between">
                <div id="submitError" class="text-sm text-red-600 hidden"></div>
                <div class="flex flex-col items-end gap-2">
                    <button id="submitBtn" type="submit"
                            class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-5 py-2.5 text-sm font-semibold text-white hover:bg-blue-700 disabled:cursor-not-allowed disabled:bg-blue-300">
                        创建任务
                    </button>
                    <a href="/jobs" class="text-xs text-gray-600 hover:text-gray-800">查看任务列表 →</a>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const form = document.getElementById('bitstreamForm');
const submitBtn = document.getElementById('submitBtn');
const submitError = document.getElementById('submitError');
const refDrop = document.getElementById('refDrop');
const refInput = document.getElementById('refInput');
const encDrop = document.getElementById('encDrop');
const encInput = document.getElementById('encInput');
const refPath = document.getElementById('refPath');
const rawParams = document.getElementById('rawParams');
const refFileName = document.getElementById('refFileName');
const encFileName = document.getElementById('encFileName');

function showError(message) {
  submitError.textContent = message;
  submitError.classList.remove('hidden');
}

function clearError() {
  submitError.textContent = '';
  submitError.classList.add('hidden');
}

form.addEventListener('submit', async (event) => {
  event.preventDefault();
  clearError();

  // 前置校验：Ref 必填其一
  const hasRef = (refPath.value && refPath.value.trim().length > 0) || (refInput.files && refInput.files.length > 0);
  if (!hasRef) {
    showError('请填写参考视频路径或上传参考视频');
    return;
  }
  // Encoded 必填其一
  const hasEncPath = encPaths.value && encPaths.value.trim().length > 0;
  const hasEncFile = encInput.files && encInput.files.length > 0;
  if (!hasEncPath && !hasEncFile) {
    showError('请填写至少一个编码视频路径或上传编码视频');
    return;
  }

  submitBtn.disabled = true;
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '创建中...';

  try {
    const formData = new FormData(form);

    const response = await fetch('/api/jobs/bitstream', {
      method: 'POST',
      body: formData,
    });

    const payload = await response.json().catch(() => ({}));

    if (!response.ok) {
      throw new Error(payload.detail || '创建任务失败');
    }

    if (!payload.job_id) {
      throw new Error('服务端未返回 job_id');
    }

    window.location.href = `/jobs/${payload.job_id}`;
  } catch (err) {
    showError(err.message || '创建任务失败');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
});

function bindDropZone(dropEl, inputEl, multiple = false, onFilesChanged = () => {}) {
  const toggleHover = (active) => {
    if (active) {
      dropEl.classList.add('border-blue-500', 'bg-blue-50');
    } else {
      dropEl.classList.remove('border-blue-500', 'bg-blue-50');
    }
  };

  ['dragenter', 'dragover'].forEach((evt) => {
    dropEl.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleHover(true);
    });
  });

  ['dragleave', 'drop'].forEach((evt) => {
    dropEl.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleHover(false);
    });
  });

  dropEl.addEventListener('drop', (e) => {
    const files = e.dataTransfer?.files;
    if (!files || files.length === 0) return;
    const dt = new DataTransfer();
    Array.from(files).forEach((f, idx) => {
      if (!multiple && idx > 0) return;
      dt.items.add(f);
    });
    inputEl.files = dt.files;
    onFilesChanged();
  });

  dropEl.addEventListener('click', () => inputEl.click());
}

bindDropZone(refDrop, refInput, false, () => {
  setFileNames(refInput, refFileName);
  updateRawParamsVisibility();
});
bindDropZone(encDrop, encInput, true, () => setFileNames(encInput, encFileName));

function isYuvFile(name = '') {
  return name.trim().toLowerCase().endsWith('.yuv');
}

function updateRawParamsVisibility() {
  const fromPath = refPath.value;
  const fromFile = refInput.files && refInput.files[0] ? refInput.files[0].name : '';
  const needYuv = isYuvFile(fromPath) || isYuvFile(fromFile);
  rawParams.classList.toggle('hidden', !needYuv);
}

refPath.addEventListener('input', updateRawParamsVisibility);
refInput.addEventListener('change', updateRawParamsVisibility);

encInput.addEventListener('change', () => {
  const bad = Array.from(encInput.files || []).some(f => isYuvFile(f.name));
  if (bad) {
    encInput.value = '';
    alert('Encoded 不接受 .yuv，请选择容器或 h264/h265 裸流');
  }
});

function setFileNames(el, target) {
  const names = Array.from(el.files || []).map(f => f.name);
  target.textContent = names.length ? `已选择：${names.join(', ')}` : '';
}

refInput.addEventListener('change', () => setFileNames(refInput, refFileName));
encInput.addEventListener('change', () => setFileNames(encInput, encFileName));
</script>
{% endblock %}
