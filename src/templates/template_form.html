{% extends "base.html" %}

{% block title %}{{ '编辑模板' if template_id else '创建模板' }} - VMA{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">
  <div class="bg-white rounded-lg shadow-sm p-6">
    <h1 class="text-2xl font-bold text-gray-900">{{ '编辑模板' if template_id else '创建模板' }}</h1>
    <p class="mt-1 text-sm text-gray-600">配置转码模板（对比或 Metrics 分析）。</p>
  </div>

<form id="templateForm" class="bg-white rounded-lg shadow-sm p-6 space-y-6">
    <!-- 基本信息 -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-900">基本信息</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">模板类型<span class="text-red-500">*</span></label>
          <select id="template_type" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
            <option value="metrics_analysis">Metrics分析</option>
            <option value="comparison" selected>Metrics对比</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">模板名称<span class="text-red-500">*</span></label>
        <input id="name" name="name" required maxlength="100" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">描述</label>
        <input id="description" name="description" maxlength="500" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
      </div>
    </div>

    <!-- 公共源视频目录（仅 Metrics对比 模式显示） -->
    <div id="common_source_section" class="space-y-4 border-t pt-6">
      <h2 class="text-lg font-semibold text-gray-900">输入设置</h2>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">源视频目录<span class="text-red-500">*</span></label>
        <input id="common_source_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" required />
        <p class="text-xs text-gray-500 mt-1">Baseline 和 Test 共用此源视频目录。YUV文件名格式需满足：stream_wxh_fps.yuv。</p>
      </div>
    </div>

    <!-- Baseline / 单侧 -->
    <div class="space-y-4 border-t pt-6">
      <div class="flex items-center justify-between">
        <h2 id="baseline_title" class="text-lg font-semibold text-gray-900">Baseline 对照组</h2>
        <label class="flex items-center text-sm text-gray-700 space-x-2">
          <input type="checkbox" id="baseline_skip" class="h-4 w-4 text-blue-600 border-gray-300 rounded" />
          <span>跳过视频编码</span>
        </label>
      </div>
      <!-- Metrics分析模式下的源视频目录 -->
      <div id="baseline_source_section" class="hidden">
        <label class="block text-sm font-medium text-gray-700 mb-1">源视频目录<span class="text-red-500">*</span></label>
        <input id="baseline_source_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
        <p class="text-xs text-gray-500 mt-1">YUV文件名格式需满足：stream_wxh_fps.yuv。</p>
      </div>
      <div id="baseline_encode_block" class="space-y-4">
        <!-- 第一行：编码器类型 + 编码器路径 -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">编码器类型<span class="text-red-500">*</span></label>
            <select id="baseline_encoder_type" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="ffmpeg" selected>FFmpeg</option>
              <option value="x264">x264</option>
              <option value="x265">x265</option>
              <option value="vvenc">VVenC</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">编码器路径</label>
            <input id="baseline_encoder_path" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="可选，留空则使用系统默认路径" />
          </div>
        </div>
        <!-- 第二行：编码参数 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">编码参数<span class="text-red-500">*</span></label>
          <input id="baseline_encoder_params" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
        </div>
        <!-- 第三行：RC + 码率点位 -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">RC<span class="text-red-500">*</span></label>
            <select id="baseline_rate_control" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="crf" selected>CRF</option>
              <option value="abr">ABR</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">码率点位（逗号分隔，最少4个点位）<span class="text-red-500">*</span></label>
            <input id="baseline_bitrate_points" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="如：21,24,27,29" />
          </div>
        </div>
        <!-- 第四行：码流目录 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">码流目录<span class="text-red-500">*</span></label>
          <input id="baseline_bitstream_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" required />
        </div>
      </div>
    </div>

    <!-- Test -->
    <div id="exp_section" class="space-y-4 border-t pt-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Test 实验组</h2>
        <label class="flex items-center text-sm text-gray-700 space-x-2">
          <input type="checkbox" id="exp_skip" class="h-4 w-4 text-blue-600 border-gray-300 rounded" />
          <span>跳过视频编码</span>
        </label>
      </div>
      <div id="exp_encode_block" class="space-y-4">
        <!-- 第一行：编码器类型 + 编码器路径 -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">编码器类型<span class="text-red-500">*</span></label>
            <select id="exp_encoder_type" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="ffmpeg" selected>FFmpeg</option>
              <option value="x264">x264</option>
              <option value="x265">x265</option>
              <option value="vvenc">VVenC</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">编码器路径</label>
            <input id="exp_encoder_path" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="可选，留空则使用系统默认路径" />
          </div>
        </div>
        <!-- 第二行：编码参数 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">编码参数<span class="text-red-500">*</span></label>
          <input id="exp_encoder_params" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
        </div>
        <!-- 第三行：RC + 码率点位 -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">RC<span class="text-red-500">*</span></label>
            <select id="exp_rate_control" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="crf" selected>CRF</option>
              <option value="abr">ABR</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">码率点位（逗号分隔，最少4个点位）<span class="text-red-500">*</span></label>
            <input id="exp_bitrate_points" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="如：21,24,27,29" />
          </div>
        </div>
        <!-- 第四行：码流目录 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">码流目录<span class="text-red-500">*</span></label>
          <input id="exp_bitstream_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" required />
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-between pt-4 border-t">
      <div id="formError" class="text-sm text-red-600"></div>
      <div class="space-x-3">
        <a href="/templates" class="text-sm text-gray-600 hover:text-gray-900">返回</a>
        {% if readonly %}
        <a href="/templates/{{ template_id }}/edit{% if request.query_params.get('type') == 'metrics' %}?type=metrics{% endif %}" class="px-4 py-2 rounded bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">编辑</a>
        {% else %}
        <button id="submitBtn" type="submit" class="px-4 py-2 rounded bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">保存模板</button>
        {% endif %}
      </div>
    </div>
  </form>
</div>

<script>
const tmplId = "{{ template_id or '' }}";
const READONLY = {{ 'true' if readonly else 'false' }};
const form = document.getElementById('templateForm');
const errBox = document.getElementById('formError');
const submitBtn = document.getElementById('submitBtn');
const urlParams = new URLSearchParams(window.location.search);
const initialType = urlParams.get('type') === 'metrics' ? 'metrics_analysis' : 'comparison';

function $(id) { return document.getElementById(id); }
const baselineSkip = $('baseline_skip');
const expSkip = $('exp_skip');
const baselineEncode = $('baseline_encode_block');
const expEncode = $('exp_encode_block');
const templateTypeSelect = $('template_type');
const expSection = $('exp_section');
const baselineTitle = $('baseline_title');
const commonSourceSection = $('common_source_section');
const baselineSourceSection = $('baseline_source_section');

function toggleBlocks() {
  baselineEncode.classList.toggle('hidden', baselineSkip.checked);
  expEncode.classList.toggle('hidden', expSkip.checked);
}
baselineSkip.addEventListener('change', toggleBlocks);
expSkip.addEventListener('change', toggleBlocks);
toggleBlocks();

function applyTypeUI(type) {
  if (type === 'metrics_analysis') {
    expSection.classList.add('hidden');
    baselineTitle.textContent = '编码配置';
    commonSourceSection.classList.add('hidden');
    baselineSourceSection.classList.remove('hidden');
  } else {
    expSection.classList.remove('hidden');
    baselineTitle.textContent = 'Baseline 对照组';
    commonSourceSection.classList.remove('hidden');
    baselineSourceSection.classList.add('hidden');
  }
}
templateTypeSelect.addEventListener('change', () => applyTypeUI(templateTypeSelect.value));
applyTypeUI(initialType);

function parsePoints(val) {
  if (!val) return [];
  return val.split(',').map(s => s.trim()).filter(Boolean).map(Number).filter(v => !Number.isNaN(v));
}

function collectSide(prefix) {
  const type = templateTypeSelect.value;
  let sourceDir = '';
  if (type === 'metrics_analysis') {
    sourceDir = $(prefix + '_source_dir')?.value.trim() || '';
  } else {
    sourceDir = $('common_source_dir')?.value.trim() || '';
  }
  return {
    skip_encode: $(prefix + '_skip').checked,
    source_dir: sourceDir,
    encoder_type: $(prefix + '_encoder_type').value || null,
    encoder_path: $(prefix + '_encoder_path')?.value.trim() || null,
    encoder_params: $(prefix + '_encoder_params').value.trim() || null,
    rate_control: $(prefix + '_rate_control').value || null,
    bitrate_points: parsePoints($(prefix + '_bitrate_points').value),
    bitstream_dir: $(prefix + '_bitstream_dir').value.trim(),
  };
}

async function loadTemplate() {
  if (!tmplId) return;
  try {
    let res = await fetch(`/api/templates/${tmplId}`);
    let data;
    if (res.ok) {
      data = await res.json();
    } else {
      const metricsRes = await fetch(`/api/metrics-analysis/templates/${tmplId}`);
      if (!metricsRes.ok) throw new Error('加载模板失败');
      data = await metricsRes.json();
      data.template_type = 'metrics_analysis';
      data.baseline = data.config;
      data.test = null;
    }
    templateTypeSelect.value = data.template_type || 'comparison';
    applyTypeUI(templateTypeSelect.value);
    $('name').value = data.name || '';
    $('description').value = data.description || '';
    const fill = (prefix, side) => {
      if (!side) return;
      $(prefix + '_source_dir').value = side.source_dir || '';
      $(prefix + '_bitstream_dir').value = side.bitstream_dir || '';
      $(prefix + '_skip').checked = !!side.skip_encode;
      $(prefix + '_encoder_type').value = side.encoder_type || '';
      $(prefix + '_encoder_path').value = side.encoder_path || '';
      $(prefix + '_encoder_params').value = side.encoder_params || '';
      $(prefix + '_rate_control').value = side.rate_control || '';
      $(prefix + '_bitrate_points').value = (side.bitrate_points || []).join(',');
    };
    fill('baseline', data.baseline);
    fill('exp', data.test);
    // 对比模式下，填充公共源视频目录
    if (data.template_type === 'comparison' && data.baseline?.source_dir) {
      $('common_source_dir').value = data.baseline.source_dir || '';
    }
    toggleBlocks();
    if (READONLY) setReadonlyMode();
  } catch (e) {
    errBox.textContent = e.message || '加载模板失败';
  }
}

function setReadonlyMode() {
  if (!READONLY) return;
  const inputs = form.querySelectorAll('input, select, textarea, button');
  inputs.forEach(el => {
    // 保留顶部导航的“返回/编辑”按钮
    if (el.id === 'submitBtn') {
      el.style.display = 'none';
      return;
    }
    if (el.closest('a')) return;
    el.disabled = true;
  });
}
// 初始化类型选择
templateTypeSelect.value = initialType;
applyTypeUI(initialType);
loadTemplate();

form.addEventListener('submit', async (e) => {
  if (READONLY) {
    e.preventDefault();
    return;
  }
  e.preventDefault();
  errBox.textContent = '';
  submitBtn.disabled = true;
  const payload = {
    name: $('name').value.trim(),
    description: $('description').value.trim() || null,
    baseline: collectSide('baseline'),
    test: collectSide('exp'),
  };
  const type = templateTypeSelect.value;
  const method = tmplId ? 'PUT' : 'POST';
  let url;
  if (type === 'metrics_analysis') {
    url = tmplId ? `/api/metrics-analysis/templates/${tmplId}` : '/api/metrics-analysis/templates';
    payload.config = payload.baseline;
    delete payload.baseline;
    delete payload.test;
  } else {
    url = tmplId ? `/api/templates/${tmplId}` : '/api/templates';
  }
  try {
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.detail || '保存失败');
    const redirectType = type === 'metrics_analysis' ? '?type=metrics' : '';
    window.location.href = '/templates' + redirectType;
  } catch (err) {
    errBox.textContent = err.message || '保存失败';
  } finally {
    submitBtn.disabled = false;
  }
});
</script>
{% endblock %}
